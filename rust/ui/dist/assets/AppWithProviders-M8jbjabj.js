import{r as t,j as o}from"./index-Br3NuR-L.js";import{c as S,R as A}from"./grpcStream-6CgmIi4o.js";import{B as C,S as x}from"./AudioMeterSidebar-CNcLsAB7.js";import{M as k,S as E,D as _,A as j,a as b}from"./MainLayout-DaBruAIv.js";import"./core-DhEqZVGG.js";const D=r=>{const[i,l]=t.useState(!1),f=r&&r.trim().length>0?r:void 0,[a,u]=t.useState(f),c=t.useRef(null),d=t.useRef(new Map),R=t.useRef(null),v=t.useCallback((e,n)=>(d.current.has(e)||d.current.set(e,new Set),d.current.get(e)?.add(n),()=>{d.current.get(e)?.delete(n)}),[]),m=(e,n)=>{const s=d.current.get(e);s&&s.forEach(h=>h(n))};t.useEffect(()=>{if(r&&r.trim().length>0){u(r);return}try{const{ipcRenderer:e}=window.require?.("electron")||{};if(e?.invoke){e.invoke("get-grpc-address").then(n=>u(n)).catch(()=>u(void 0));return}}catch{}u(void 0)},[r]);const g=t.useCallback(()=>{if(!a||a.trim().length===0)return;const e=S(a);e.onopen=()=>{l(!0),console.log("Connected to backend (gRPC)")},e.onmessage=n=>{try{const s=JSON.parse(n.data);s.type&&m(s.type,s)}catch(s){console.error("gRPC parse error:",s)}},e.onclose=()=>{l(!1),c.current=null,R.current=setTimeout(g,3e3)},e.onerror=n=>{console.error("gRPC stream error:",n)},c.current=e},[a]);t.useEffect(()=>(g(),()=>{c.current&&c.current.close(),R.current&&clearTimeout(R.current)}),[g,a]);const P=t.useCallback(async e=>{if(c.current?.readyState===A.OPEN){c.current.send(JSON.stringify(e));return}else{console.warn("gRPC not connected, message dropped:",e);return}},[]);return{isConnected:i,sendMessage:P,subscribe:v}};var p={};const w=({children:r})=>{const i=typeof process<"u"&&p.AIWISPER_GRPC_ADDR&&p.AIWISPER_GRPC_ADDR.trim().length>0?p.AIWISPER_GRPC_ADDR:void 0,f={...D(i),isTauri:!1};return o.jsx(C.Provider,{value:f,children:r})},G=()=>{const r=t.useCallback(i=>{console.log(`[AIWisper] ${i}`)},[]);return o.jsx(w,{children:o.jsx(k,{children:o.jsx(x,{children:o.jsx(E,{children:o.jsx(_,{children:o.jsx(j,{children:o.jsx(b,{addLog:r})})})})})})})};export{G as AppWithProviders,G as default};
