# План улучшения распознавания GigaAM и формирования диалогов

**Дата**: 2025-12-10
**Статус**: ✅ Завершено
**Приоритет**: Высокий
**Обновлено**: 2025-12-10

## Выявленные проблемы

### Проблема 1: Склеивание слов в GigaAM

**Симптом**: Слова склеиваются без пробелов
```
"вопросеянеможо" → должно быть "вопросе я не могу"
"какомсостояни" → должно быть "каком состоянии"
"сейчас комад" → должно быть "сейчас команда"
```

**Причина**: GigaAM v3 CTC использует character-level токенизацию (34 токена: 32 буквы + `▁` + `<blk>`). Токен `▁` обозначает границу слова. При быстрой речи или фонетическом слиянии модель не всегда выдаёт `▁` между словами.

**Текущий декодер** (`backend/ai/gigaam.go:416-508`):
- Greedy CTC decoding
- `▁` интерпретируется как начало нового слова
- Логика корректна, проблема на уровне выхода модели

### Проблема 2: Большие блоки одного спикера вместо диалога

**Симптом**: Вместо чередования "вопрос-ответ" получаем:
```
[02:13] Собеседник 2: [огромный блок текста на 30 секунд]
[02:14] Вы: [огромный блок текста на 30 секунд]
```

**Причина**: Текущая логика в `mergeWordsToDialogue()` (`backend/session/manager.go:489-515`):
1. Группирует слова каждого канала в фразы по паузам >2 секунд
2. Объединяет все фразы и сортирует по времени начала
3. Если человек говорит 30 секунд без пауз >2сек — это одна "фраза"

**Результат**: Теряется структура диалога, невозможно понять контекст разговора.

### Проблема 3: Обработка тишины в каналах

**Симптом**: Медленная обработка, возможные галлюцинации.

**Причина**: Каждый канал (mic/sys) транскрибируется целиком, включая большие участки тишины (когда говорит другой участник).

**Пример**: 30-секундный чанк mic может содержать только 5 секунд речи, остальное — тишина (пока говорит собеседник).

---

## План решения

### Фаза 1: Улучшение структуры диалога [ВЫСОКИЙ ПРИОРИТЕТ]

#### 1.1 Умная сегментация фраз

**Задача**: Разбивать длинные реплики на логические части для создания естественного диалога.

**Изменения в `backend/session/manager.go`**:

```go
const (
    maxPauseMs     = 2000  // Пауза для разделения фраз (текущее)
    maxPhraseMs    = 10000 // НОВОЕ: Максимальная длина фразы (10 сек)
    minPhraseMs    = 1000  // НОВОЕ: Минимальная длина фразы (1 сек)
    overlapWindowMs = 500  // НОВОЕ: Окно для определения пересечений
)
```

**Новый алгоритм `groupWordsToPhrases()`**:
1. Текущая логика: разделение по паузам >2сек
2. ДОБАВИТЬ: Принудительное разделение при достижении maxPhraseMs
3. ДОБАВИТЬ: Поиск лучшей точки разделения (пауза, конец предложения)
4. ДОБАВИТЬ: Учёт знаков препинания для смыслового разделения

#### 1.2 Интерливинг (чередование) диалога

**Задача**: Корректно смешивать реплики mic и sys по реальному времени.

**Новая функция `interleaveDialogue()`**:
```go
// interleaveDialogue создаёт естественный диалог с чередованием спикеров
// Учитывает перекрытия речи и создаёт логичную последовательность
func interleaveDialogue(micPhrases, sysPhrases []TranscriptSegment) []TranscriptSegment {
    // 1. Объединить все фразы
    // 2. Сортировать по времени начала
    // 3. Обнаружить пересечения по времени
    // 4. При пересечении: разбить на части или пометить как одновременную речь
    // 5. Вернуть отсортированный диалог
}
```

**Обработка пересечений**:
- Если mic и sys говорят одновременно (timestamps пересекаются):
  - Вариант A: Разбить на более мелкие сегменты
  - Вариант B: Пометить `[одновременно]`
  - Вариант C: Упорядочить по началу, даже если есть overlap

#### 1.3 Файлы для изменения

| Файл | Изменения |
|------|-----------|
| `backend/session/manager.go` | Новый алгоритм группировки, интерливинг |
| `backend/session/types.go` | Константы конфигурации |

---

### Фаза 2: Исправление текста через LLM [ВЫСОКИЙ ПРИОРИТЕТ]

#### 2.1 Улучшенный промпт для исправления

**Текущий промпт** (`backend/internal/service/llm.go:126-130`):
```
Исправляй ошибки распознавания, пунктуацию и регистр.
```

**Новый промпт**:
```
Ты — эксперт по редактированию транскрипций русской речи.

ТВОИ ЗАДАЧИ:
1. РАЗДЕЛЯЙ СКЛЕЕННЫЕ СЛОВА: "вопросеянеможо" → "вопросе я не могу"
2. Добавляй пунктуацию (точки, запятые, вопросительные знаки)
3. Исправляй регистр (начало предложения с заглавной)
4. Исправляй очевидные ошибки распознавания
5. РАЗБИВАЙ длинные реплики (>3 предложений) на отдельные строки с тем же спикером

ФОРМАТ ВХОДА:
[Вы] текст реплики
[Собеседник] текст реплики

ФОРМАТ ВЫХОДА (тот же):
[Вы] Исправленный текст.
[Собеседник] Исправленный текст.

ПРАВИЛА:
- НЕ меняй смысл
- НЕ удаляй реплики
- НЕ объединяй реплики разных спикеров
- Сохраняй порядок реплик
- Если реплика длинная — разбей на несколько строк с тем же спикером
```

#### 2.2 Автоматическое улучшение после транскрипции

**Новый флаг конфигурации**:
```go
type TranscriptionConfig struct {
    AutoImproveWithLLM bool   // Автоматически улучшать через LLM
    LLMModel           string // Модель для улучшения
}
```

**Flow**:
1. GigaAM транскрибирует → сырой текст
2. Формируется диалог (Фаза 1)
3. Если AutoImproveWithLLM=true → отправляем в LLM
4. Сохраняем оба варианта: `RawDialogue` и `ImprovedDialogue`

#### 2.3 Файлы для изменения

| Файл | Изменения |
|------|-----------|
| `backend/internal/service/llm.go` | Улучшенный промпт, парсинг разбитых реплик |
| `backend/internal/service/transcription.go` | Автовызов LLM после транскрипции |
| `backend/internal/api/server.go` | Эндпоинт для настройки авто-улучшения |

---

### Фаза 3: VAD Preprocessing [СРЕДНИЙ ПРИОРИТЕТ]

#### 3.1 Удаление тишины перед транскрипцией

**Цель**: Ускорение и улучшение качества за счёт обработки только участков с речью.

**Новая функция в `backend/session/vad.go`**:
```go
// CompressSpeechWithMapping удаляет тишину и возвращает маппинг timestamps
// compressedSamples - аудио только с речью
// timestampMap - маппинг: позиция в сжатом → позиция в оригинале
func CompressSpeechWithMapping(samples []float32, sampleRate int) (
    compressedSamples []float32,
    timestampMap []TimestampMapping,
    err error,
)

type TimestampMapping struct {
    CompressedMs int64 // Позиция в сжатом аудио
    OriginalMs   int64 // Позиция в оригинальном аудио
}
```

**Flow**:
```
[Канал WAV 30сек] 
    ↓
[VAD: найти речевые регионы] → [(0-5сек речь), (15-20сек речь)]
    ↓
[Извлечь только речь] → [10 сек аудио]
    ↓
[Создать timestamp map] → [{0→0}, {5000→15000}, ...]
    ↓
[GigaAM транскрибирует 10сек]
    ↓
[Восстановить оригинальные timestamps через map]
```

#### 3.2 Интеграция в transcription.go

**Изменения в `processStereoFromMP3()`**:
```go
// Перед транскрипцией:
micCompressed, micMap := CompressSpeechWithMapping(micSamples, 16000)
sysCompressed, sysMap := CompressSpeechWithMapping(sysSamples, 16000)

// Транскрипция сжатого аудио
micSegments := transcribe(micCompressed)
sysSegments := transcribe(sysCompressed)

// Восстановление timestamps
micSegments = RestoreTimestamps(micSegments, micMap)
sysSegments = RestoreTimestamps(sysSegments, sysMap)
```

#### 3.3 Преимущества

| Метрика | До | После |
|---------|-----|-------|
| Время обработки 30сек чанка | ~3 сек | ~1-2 сек |
| Галлюцинации на тишине | Возможны | Исключены |
| Точность timestamps | Средняя | Высокая |

#### 3.4 Файлы для изменения

| Файл | Изменения |
|------|-----------|
| `backend/session/vad.go` | CompressSpeechWithMapping, RestoreTimestamps |
| `backend/internal/service/transcription.go` | Интеграция VAD preprocessing |

---

### Фаза 4: Улучшение CTC декодера [НИЗКИЙ ПРИОРИТЕТ]

#### 4.1 Эвристики границ слов

**Идея**: Если модель не выдала `▁`, попытаться определить границу слова по косвенным признакам.

**Эвристики**:
1. **Confidence drop**: Резкое падение уверенности модели = вероятная граница
2. **Pause detection**: Микропауза в logits (несколько blank подряд)
3. **Phonetic patterns**: После гласной, перед согласной = возможная граница

**Изменения в `decodeCTCWithTimestamps()`**:
```go
// Добавить анализ confidence между токенами
if prevConfidence > 0.8 && currentConfidence < 0.3 {
    // Вероятная граница слова — вставить пробел
}
```

#### 4.2 Beam Search (опционально)

**Преимущества**: Более точное декодирование
**Недостатки**: В 3-5 раз медленнее

**Рекомендация**: Реализовать как опцию для "высококачественного" режима.

#### 4.3 Файлы для изменения

| Файл | Изменения |
|------|-----------|
| `backend/ai/gigaam.go` | Эвристики в decodeCTCWithTimestamps |

---

## Порядок реализации

### Спринт 1 (Критично) ✅ ЗАВЕРШЕНО
1. [x] Фаза 2.1: Улучшенный LLM промпт
2. [x] Фаза 1.1: Ограничение длины фраз (maxPhraseMs)
3. [x] Фаза 1.2: Базовый интерливинг

**Результат**: Читаемый диалог с исправленными склейками слов.

### Спринт 2 (Важно) ✅ ЗАВЕРШЕНО
4. [x] Фаза 2.2: Автоматическое улучшение через LLM
5. [x] Фаза 3.1-3.2: VAD preprocessing

**Результат**: Автоматическое качество + ускорение.

### Спринт 3 (Улучшения) ✅ ЗАВЕРШЕНО
6. [x] Фаза 4.1: Эвристики CTC декодера (confidence drop + blank sequence detection)
7. [x] Фаза 1.2: Продвинутый интерливинг (обработка overlap)

**Результат**: Меньше работы для LLM, лучше сырое качество.

---

## Метрики успеха

| Метрика | Текущее | Цель |
|---------|---------|------|
| Склеенные слова на 100 слов | ~5-10 | <1 (после LLM) |
| Средняя длина реплики | 30+ сек | 5-15 сек |
| Чередование спикеров | Блоки | Естественный диалог |
| Время обработки чанка | ~3 сек | ~2 сек |

---

## Риски и митигация

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| LLM вносит ошибки | Средняя | Сохранять оригинал, низкая temperature |
| Неточные timestamps после VAD | Низкая | Тесты на реальных записях |
| Сложность разбиения overlap | Средняя | Простой алгоритм сначала |

---

## Зависимости

- **Ollama**: Должен быть запущен для LLM улучшения
- **Модель**: Рекомендуется модель с хорошим русским (llama3, qwen2)

---

## Ссылки

- GigaAM: https://github.com/salute-developers/GigaAM
- WhisperX VAD подход: https://github.com/m-bain/whisperX
- SentencePiece токенизация: https://github.com/google/sentencepiece

---

## Итоговая реализация

### Фаза 1: Улучшение структуры диалога
**Файл**: `backend/session/manager.go`
- Добавлены константы: `maxPhraseDurationMs`, `minPhraseDurationMs`, `shortPauseMs`
- Функция `groupWordsToPhrases()` разбивает длинные фразы на части
- Функция `interleaveDialogue()` правильно чередует mic/sys сегменты по времени
- Обработка пересечений речи с обрезкой перекрывающихся сегментов

### Фаза 2: LLM Auto-Improvement
**Файлы**: `backend/internal/service/llm.go`, `transcription.go`, `config/config.go`, `api/server.go`, `api/types.go`, `main.go`
- Детальный промпт для разделения склеенных слов и исправления текста
- Поддержка нумерованных собеседников (Собеседник 1, 2, ...)
- Функция `autoImproveChunk()` вызывается после транскрипции
- WebSocket команды: `set_auto_improve`, `get_auto_improve_status`
- Флаги конфигурации: `--auto-improve`, `--ollama-url`, `--ollama-model`

### Фаза 3: VAD Preprocessing
**Файлы**: `backend/session/vad.go`, `backend/internal/service/transcription.go`
- Функция `CompressSpeech()` удаляет тишину из аудио
- Структура `SpeechRegion` хранит маппинг timestamps
- Функции `RestoreSegmentTimestamps()` и `restoreAISegmentTimestamps()` восстанавливают оригинальные timestamps
- Интеграция VAD в процесс транскрипции

### Фаза 4: Эвристики CTC декодера
**Файл**: `backend/ai/gigaam.go`
- Константы: `confidenceDropThreshold`, `minBlankSequenceForPause`, `minWordLengthForSplit`
- **Pause detection**: Если несколько blank токенов подряд — сохраняем текущее слово как завершённое
- **Confidence drop**: Резкое падение уверенности модели указывает на возможную границу слова

### Сборка
```bash
cd backend && go build -o aiwisper-backend .
```
Проект успешно компилируется.
